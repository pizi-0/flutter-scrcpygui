name: Build Platform-Specific Artifacts

on:
  # 1. MODIFICATION: Define an input for the OS selection
  workflow_dispatch:
    inputs:
      os:
        description: 'OS to build for (windows-latest, ubuntu-22.04, macos-latest)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - windows-latest
          - ubuntu-22.04
          - macos-latest

jobs:
  build:
    strategy:
      matrix:
        os: ${{ fromJSON(github.event.inputs.os == 'all' && '["windows-latest", "ubuntu-22.04", "macos-latest"]' || format('["{0}"]', github.event.inputs.os)) }}
        
        include:
          - os: windows-latest
            platform: windows
          - os: ubuntu-22.04
            platform: linux
          - os: macos-latest
            platform: macos

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: 3.35.1
          cache: true

      - name: Prepare pubspec.yaml for Windows
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          (Get-Content pubspec.yaml) | ForEach-Object {
            $_ -replace '    - assets/exec/linux/', '#    - assets/exec/linux/' `
               -replace '    - assets/exec/mac-intel/', '#    - assets/exec/mac-intel/' `
               -replace '    - assets/exec/mac-apple/', '#    - assets/exec/mac-apple/'
          } | Set-Content pubspec.yaml
          echo "--- Modified pubspec.yaml for Windows build ---"
          type pubspec.yaml

      - name: Prepare pubspec.yaml for Linux
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get install libayatana-appindicator3-dev
          sed -i -e 's|    - assets/exec/windows/|#   - assets/exec/windows/|' \
                 -e 's|    - assets/exec/mac-intel/|#   - assets/exec/mac-intel/|' \
                 -e 's|    - assets/exec/mac-apple/|#   - assets/exec/mac-apple/|' pubspec.yaml
          echo "--- Modified pubspec.yaml for Linux build ---"
          cat pubspec.yaml

      - name: Prepare pubspec.yaml for macOS
        if: matrix.platform == 'macos'
        run: |
          sed -i '' -e 's|    - assets/exec/windows/|#   - assets/exec/windows/|' \
                    -e 's|    - assets/exec/linux/|#   - assets/exec/linux/|' pubspec.yaml
          echo "--- Modified pubspec.yaml for macOS build ---"
          cat pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build application
        run: flutter build ${{ matrix.platform }} --release

      - name: Upload Windows Artifact
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows/x64/runner/Release/
          if-no-files-found: error

      - name: Upload Linux Artifact
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux/x64/release/bundle/
          if-no-files-found: error
          
      - name: Zip macOS App Bundle
        if: matrix.platform == 'macos'
        run: |
          APP_PATH="build/macos/Build/Products/Release/Scrcpy GUI.app"
          ZIP_NAME="macos-Scrcpy-GUI.zip"
          
          cd $(dirname "$APP_PATH")
          
          zip -r "$ZIP_NAME" "$(basename "$APP_PATH")"
          
          echo "Zip file created at: $(pwd)/$ZIP_NAME"

      - name: Upload macOS Artifact
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/macos/Build/Products/Release/macos-Scrcpy-GUI.zip
          if-no-files-found: error